<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Config Settings</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body style="padding: 2vh;">
    <h1>Config Settings</h1>

    <label for="zone">Zone:</label>
    <input type="text" id="zone" value="Change zone in app" disabled><br>

    <label for="time-format">Time Format:</label>
    <select id="time-format">
        <option value="12" selected>12-Hour</option>
        <option value="24">24-Hour</option>
    </select><br>

    <h2>Other Prayer Times</h2>

    <input type="checkbox" id="imsak" checked>
    <label for="imsak">Imsak</label><br>

    <input type="checkbox" id="syuruk" checked>
    <label for="syuruk">Syuruk</label><br>

    <input type="checkbox" id="dhuha" checked>
    <label for="dhuha">Dhuha</label><br>

    <h2>Tarikh</h2>

    <label for="miladi">Miladi</label>
    <input type="checkbox" id="miladi" name="tarikh" checked><br>

    <label for="hijri">Hijri</label>
    <input type="checkbox" id="hijri" name="tarikh"><br>

    <br><button id="save">Save</button>

    <script>
        let configData;
        fetch(window.location.href.replace('config.html', 'config.json'))
            .then(response => response.json())
            .then(data => {
                configData = data;
                console.log(configData);
                // use the content of the JSON file here

                document.getElementById('time-format').value = data.time_format;
                document.getElementById('imsak').checked = data.other_prayer_times.imsak;
                document.getElementById('syuruk').checked = data.other_prayer_times.syuruk;
                document.getElementById('dhuha').checked = data.other_prayer_times.dhuha;
                document.getElementById('miladi').checked = data.tarikh.miladi;
                document.getElementById('hijri').checked = data.tarikh.hijri;

            })
            .catch(error => {
                console.error('Error fetching the JSON file:', error);
            });

        document.getElementById('save').addEventListener('click', () => {
            console.log('save button clicked');


            // form a JSON object
            var newConfigData = {
                zone: configData.zone,
                time_format: document.getElementById('time-format').value,
                other_prayer_times: {
                    imsak: document.getElementById('imsak').checked,
                    syuruk: document.getElementById('syuruk').checked,
                    dhuha: document.getElementById('dhuha').checked
                },
                tarikh: {
                    miladi: document.getElementById('miladi').checked,
                    hijri: document.getElementById('hijri').checked,
                    locale: configData.tarikh.locale
                }
            };

            console.log(newConfigData);
            let newURL = replacePort(window.location.href, 7000); // replace with server port

            console.log(`${newURL}/edit`);

            fetch(`${newURL}/edit`, {
                method: "POST",
                body: JSON.stringify(newConfigData),
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
            }).then(response => {
                // Show alert dialog when the fetch request is done
                alert("Setting saved");
            }).catch(error => {
                console.error("Error:", error);
            });
        });

        /// Replace port and delete trailing path
        function replacePort(url, newPort) {
            var parser = document.createElement('a');
            parser.href = url;
            // var newURL = parser.protocol + "//" + parser.hostname + ":" + newPort + parser.pathname;
            var newURL = parser.protocol + "//" + parser.hostname + ":" + newPort;
            return newURL;
        }

    </script>

</body>

</html>